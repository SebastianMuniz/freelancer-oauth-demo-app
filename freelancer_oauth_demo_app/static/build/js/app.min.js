'use strict';

var vm = vm || {};

vm.showSection = function (sect) {

    var sections = ['admin', 'account', 'password', 'apps', 'phone', 'create_app'];
    sections.forEach(function (entry) {
        // Show panel
        var foo = document.getElementById(entry);
        if (foo == null) return true;

        if (sect == foo.id) {
            foo.classList.remove('is-hidden');
        } else {
            foo.classList.add('is-hidden');
        }

        // Set tab
        var foo = document.getElementById(entry + "_select");
        if (foo == null) return true;

        if (sect + "_select" == foo.id) {
            foo.classList.add('is-TabLink-selected');
        } else {
            foo.classList.remove('is-TabLink-selected');
        }
    });

};

// Make an id into an editable input box
vm.makeElementEditable = function (id) {

    //append to form element that you want .
    var oldObject = document.getElementById(id);
    var newObject = document.createElement('input');
    // Cleanup the innerHTML
    newObject.value = String(oldObject.innerHTML).replace(/^\s+|\s+$/g, '');;
    newObject.name = id;
    newObject.id = oldObject.id;


    if(oldObject.size) {
        newObject.size = oldObject.size;
    }

    if(oldObject.className){
        newObject.className = oldObject.className;
    }
    oldObject.parentNode.replaceChild(newObject,oldObject);

    // Set the button to be enabled
    document.getElementById("submit_button").disabled = false;
};

vm.addKeyPair = function (key, value) {
    var input = document.createElement('input');
    input.setAttribute("type", "hidden");
    input.setAttribute("name", key);
    input.setAttribute("value", value);

    //append to form element that you want .
    document.getElementById("admin").appendChild(input);
}

$(function () {
    $('.remove-app').click(function(e) {
        var token = $(e.target).data('token');
        var placeholder = $('#app-placeholder');
        var error = $('#error-placeholder');
        $.ajax({
            url: '/oauth/revoke',
            type: 'post',
            data: {'token': token},
            dataType: 'json',
            beforeSend: function() {
                error.addClass('is-hidden');
            },
            // handle 200 status
            success: function(response) {
                if (response.status == 'success') {
                    var current_app = $(e.target).parents('.connected-app');
                    current_app.fadeOut(function() {
                        current_app.remove();
                        if ($('.connected-app').length === 0) {
                            placeholder.removeClass('is-hidden');
                        }
                    });
                } else {
                    error.html(response.message).removeClass('is-hidden');
                }
            },
            // handle other status: 404, 500 etc
            error: function(response) {
                var resp = JSON.parse(response.responseText)
                var msg = 'Unkown error, please try again later';
                if (resp.message) {
                    msg = resp.message;
                }
                error.html(msg).removeClass('is-hidden');
            }
        });
    });
});
